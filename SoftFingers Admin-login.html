<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Login - SoftFingers</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {font-family:system-ui,Arial;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f2f4f8}
    .card{width:320px;padding:22px;border-radius:10px;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,.08)}
    h2{text-align:center;margin:0 0 12px}
    input{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ddd}
    button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:none;background:#6c5ce7;color:#fff;font-weight:600;cursor:pointer}
    .hidden{display:none}
    .error{color:#c53030;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <div class="card">
    <h2>Admin Login</h2>

    <form id="login-form">
      <input id="email" type="email" placeholder="Email" required />
      <input id="password" type="password" placeholder="Password" required />
      <button type="submit">Sign in</button>
    </form>

    <form id="pin-form" class="hidden">
      <input id="pin" type="password" placeholder="Enter Admin PIN" required />
      <button type="submit">Verify PIN</button>
    </form>

    <div id="msg" class="error"></div>
  </div>

<script>
  // ===== Replace with your firebase config =====
  const firebaseConfig = {
    apiKey: "AIzaSyCoQO4vR_lIStx2lMPSy_YhHYPh75gHRSQ",
    authDomain: "softfingers-typing.firebaseapp.com",
    projectId: "softfingers-typing",
    storageBucket: "softfingers-typing.firebasestorage.app",
    messagingSenderId: "896354348357",
    appId: "1:896354348357:web:72fda3e79dce5f5b8b622c",
    measurementId: "G-SLF302PVR4"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  // Super admin and PIN
  const ADMIN_EMAIL = "mgodfred42@gmail.com";
  const ADMIN_PIN = "4321"; // change if you want

  const loginForm = document.getElementById('login-form');
  const pinForm = document.getElementById('pin-form');
  const msg = document.getElementById('msg');

  let pendingUser = null;

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('password').value;

    try {
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      const user = cred.user;

      // Auto-create/update Firestore doc for the account if needed
      const uRef = db.collection('users').doc(user.uid);
      const uSnap = await uRef.get();

      if (email === ADMIN_EMAIL) {
        // ensure this account always has role admin
        await uRef.set({
          email: user.email,
          role: 'admin',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // proceed to PIN step
        pendingUser = user;
        loginForm.classList.add('hidden');
        pinForm.classList.remove('hidden');
        return;
      }

      // if not the super admin, check role in Firestore
      if (uSnap.exists && uSnap.data().role === 'admin') {
        pendingUser = user;
        loginForm.classList.add('hidden');
        pinForm.classList.remove('hidden');
        return;
      }

      // Not admin
      msg.textContent = 'Access denied: Not an admin.';
      await auth.signOut();
    } catch (err) {
      msg.textContent = err.message || 'Login failed';
    }
  });

  pinForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    const pin = document.getElementById('pin').value.trim();
    if (!pendingUser) { msg.textContent = 'No pending sign in.'; return; }
    if (pin === ADMIN_PIN) {
      // signed in and verified â€” redirect to admin dashboard
      window.location.href = 'SoftFingers Admin.html';
    } else {
      msg.textContent = 'Invalid PIN.';
      await auth.signOut();
      // reset UI
      pinForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      pendingUser = null;
    }
  });
</script>
</body>
</html>
